## 印象最深刻的一次渗透经历？

某次护网行动中，目标为一国企单位，因为涉及敏感，不具体透露单位名。

以一个红队队员的角度，针对不同的渗透阶段进行分析：入口权限 => 内网搜集/探测 => 免杀提权[非必须] => 抓取登录凭证 => 跨平台横向 => 入口维持 => 数据回传 => 定期权限维护

### 一、入口权限获取

#### 1、信息搜集

由于目标在各级地市、乡镇均单独配备机房，只要IP属于公司即为目标。

从IP切入，使用**纯真IP数据库**导出目标公网IP段，使用**NMAP**扫描目标IP段，这里我会使用-p-扫描存活目标的全部65535个端口，使用-A列出服务详情并调用相应nse脚本进行检测。

从域名切入，使用爆破等一系列方法尽可能多的**寻找子域名**，并解析到相应IP，查缺补漏。

目标没有使用CDN，但拥有各种墙各种盾。IP也多指向自建机房，还有一些华为云。

#### 2、漏洞挖掘并利用

有个test二级域名，是基于ThinkPHP自写的CMS，前台仅有信息展示的功能，应该是未正式上线的测试站暴露在公网上。ThinkPHP为高版本，没有已泄露的漏洞。

通过dirb扫描路径，发现了**adminer**，一个数据库管理页面，还有API的帮助文档。

通过**Mysql Server端伪造-任意文件读取**漏洞，读取/etc/passwd失败但爆出adminer的绝对路径，通过读取config.php，发现mysql配置文件，得到mysql的root密码。

使用账号密码登陆adminer，很不幸PHP版本是7.x，secure_file_priv限制了读写目录；但也很庆幸，当前数据库服务用户拥有www目录的读写权限，大概是程序员图省事直接777了吧，最后利用**general_log**获得webshell，但权限很低。

### 二、主机安全

#### 1、权限提升

由于担心服务宕机，没有进一步用溢出等方法来提权。

### 三、内网安全

xxx

### 四、痕迹处理

xxx